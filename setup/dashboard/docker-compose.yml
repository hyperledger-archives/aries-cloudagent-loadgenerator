version: "3.7"
services:

  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - 3000:3000
    environment:
      GF_RENDERING_SERVER_URL: http://grafana-image-renderer:8081/render
      GF_RENDERING_CALLBACK_URL: http://grafana:3000/
      GF_LOG_FILTERS: rendering:debug
    volumes:
      - grafana-volume:/var/lib/grafana
      - ./grafana/grafana-provisioning:/etc/grafana/provisioning
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - dashboard-and-logging

  # https://grafana.com/grafana/plugins/grafana-image-renderer/#installation
  grafana-image-renderer:
    container_name: grafana-image-renderer
    image: grafana/grafana-image-renderer:latest
    ports:
      - 8081
    networks:
      - dashboard-and-logging

  # https://github.com/IzakMarais/reporter
  grafana-pdf-exporter:
    container_name: grafana-pdf-exporter
    image: izakmarais/grafana-reporter
    entrypoint: "/usr/local/bin/grafana-reporter -ip grafana:3000 -grid-layout=1"
    ports:
      - 8686:8686
    networks:
      - dashboard-and-logging

  loki:
    container_name: loki
    image: grafana/loki:2.4.2
    ports:
      - 3100:3100
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki-volume:/data/loki
      - ./loki/local-config.yaml:/etc/loki/local-config.yaml
    depends_on:
      - grafana
    networks:
      - dashboard-and-logging

  prometheus:
    container_name: prometheus
    image: prom/prometheus:v2.33.1
    ports:
      - 9090:9090
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - cadvisor
    networks:
      - dashboard-and-logging

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.39.3
    container_name: cadvisor
    command:
      - '-port=9091'
    ports:
      - 9091:9091
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    depends_on:
      - redis
    networks:
      - dashboard-and-logging

  redis:
    image: redis:6
    container_name: redis
    ports:
      - 6379:6379
    networks:
      - dashboard-and-logging

networks:
  dashboard-and-logging:
    name: dashboard-and-logging

volumes:
  grafana-volume:
  loki-volume:
